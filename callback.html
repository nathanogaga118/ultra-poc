<script>
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const state = urlParams.get('state');

  const clientId = '2f6ca3c9-87ec-4042-a464-21349485a16f';
  const redirectUri = 'https://nathanogaga118.github.io/ultra-poc/callback.html';
  const tokenEndpoint = 'https://auth.staging.ultra.io/auth/realms/ultraio/protocol/openid-connect/token';

  // IMPORTANT: This must match the code_verifier used when generating the login URL
  const codeVerifier = 'random123'; // this must be the original, unhashed value

  async function exchangeCode() {
    const data = new URLSearchParams();
    data.append('grant_type', 'authorization_code');
    data.append('code', code);
    data.append('client_id', clientId);
    data.append('redirect_uri', redirectUri);
    data.append('code_verifier', codeVerifier);

    try {
      const res = await fetch(tokenEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: data
      });

      const result = await res.json();
      console.log('✅ Access Token:', result.access_token);
      console.log('✅ ID Token:', result.id_token);
    } catch (err) {
      console.error('❌ Token exchange failed', err);
    }
  }

  exchangeCode();
</script>
